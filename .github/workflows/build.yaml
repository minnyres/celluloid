name: Build for Windows

on:
  push:

jobs:
  build-windows:
    name: Build
    runs-on: windows-latest
    env:
      install_path: "${{ github.workspace }}/install"
      mpv_path: ${{ github.workspace }}/mpv

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup devcmd
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64

      - name: Install build tools
        run: |
          choco install ninja pkgconfiglite aria2

      - name: Setup Python
        uses: actions/setup-python@v2

      - name: Install Python Dependencies
        run: pip install meson

      - name: Setup a new (or from cache) vcpkg (and does not build any package)
        uses: lukka/run-vcpkg@v11 # Always specify the specific _version_ of the
                                  # action you need, `v11` in this case to stay up
                                  # to date with fixes on the v11 branch
        with:
          vcpkgGitCommitId: 'b02e341c927f16d991edbd915d8ea43eac52096c'
          vcpkgDirectory: C:/vcpkg

      - name: Install dependencies from vcpkg
        run: |
          # clear buildtrees after each package installation to reduce disk space requirements
          $packages = `
            "glib:x64-windows-release",
            "gtk:x64-windows-release",
            "libadwaita:x64-windows-release",
            "libepoxy:x64-windows-release",
            "lua:x64-windows-release"
          ${{ env.RUNVCPKG_VCPKG_ROOT }}/vcpkg.exe upgrade `
            --no-dry-run
          ${{ env.RUNVCPKG_VCPKG_ROOT }}/vcpkg.exe install `
            --clean-after-build `
            --host-triplet=x64-windows-release `
            $packages

      - name: Install libmpv
        run: |
          mkdir -p mpv
          cd mpv
          aria2c https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/20250330/mpv-dev-x86_64-20250330-git-5ba7ee5.7z
          7z x  https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/20250330/mpv-dev-x86_64-20250330-git-5ba7ee5.7z  
          lib /name:mpv-2.dll /out:mpv.lib /MACHINE:X64   
          ls "D:\a\celluloid\celluloid\mpv\mpv.lib"  

      - name: Build
        run: |
          $env:PKG_CONFIG_PATH="${{ env.RUNVCPKG_VCPKG_ROOT }}/installed/x64-windows-release/lib/pkgconfig"    
          meson setup build --prefix=${{ env.install_path }} --buildtype release --strip -Dc_std="gnu11,c11" -Dc_args="-I ${{ env.mpv_path }}"  -Dc_link_args="${{ env.mpv_path }}/mpv.lib"
          meson compile -C build
          meson install -C build